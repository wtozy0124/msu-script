// ==UserScript==
// @name         MSU è‡ªåŠ¨äº¤æ˜“æ•´åˆç‰ˆ v2.7 (å®šæ—¶ç­–ç•¥æµ‹è¯•ç‰ˆ)
// @namespace    http://tampermonkey.net/
// @version      2.7
// @description  è‡ªåŠ¨è´­ä¹° + è‡ªåŠ¨å”®å‡º + å€’è®¡æ—¶æ§åˆ¶ + æŒ‰æ‚¨çš„è¦æ±‚ä¿®æ”¹ä¸ºå›ºå®šå»¶æ—¶ç­–ç•¥
// @match        https://msu.io/marketplace/ft/*
// @grant        none
// ==/UserScript==

/* global BigInt */



(async function () {
  'use strict';

  const storageKeyPrefix = 'msu_auto_';
  let isBuying = false;
  let isRunning = localStorage.getItem(storageKeyPrefix + 'running') === 'true';
  let targetPrice = parseInt(localStorage.getItem(storageKeyPrefix + 'price') || '310');
  let premiumPrice = parseInt(localStorage.getItem(storageKeyPrefix + 'premium') || '0');
  let sellPrice = parseInt(localStorage.getItem("msu_auto_sell") || "0");
  let collapsed = false;
  let greenErrorCooldown = false;
  let greenErrorTimer = 0;
    // æ¨¡å—ï¼šè¯†åˆ«â€œConnect Walletâ€å¼¹çª—å¹¶è‡ªåŠ¨ç‚¹å‡» MetaMask æŒ‰é’®
  const autoClickMetaMask = setInterval(() => {
    const allDivs = document.querySelectorAll('div');
    let foundBox = null;

    allDivs.forEach(div => {
      if (
        div.innerText.includes('Connect Wallet') &&
        div.innerText.includes('MapleStory Universe')
      ) {
        foundBox = div;
      }
    });

    if (foundBox) {
      const button = foundBox.querySelector('button');
      if (button) {
        button.click();
        console.log('âœ… å·²ç‚¹å‡» MetaMask æŒ‰é’®');
        clearInterval(autoClickMetaMask); // åªç‚¹ä¸€æ¬¡
      }
    }
  }, 1000); // æ¯ç§’æ£€æµ‹ä¸€æ¬¡

  let mainLoopRunning = false;
  let countdown = 1500;

  const countdownKey = 'msu_auto_countdown';
  const savedCountdown = parseInt(localStorage.getItem(countdownKey));
  if (!isNaN(savedCountdown)) {
     countdown = savedCountdown;
     console.log("âœ… æ¢å¤ countdown =", countdown);
     localStorage.removeItem(countdownKey); // é¿å…ä¸‹æ¬¡è¯¯ç”¨
  }


  const pathname = window.location.pathname;
  const matchedId = pathname.match(/ft\/(\d+)/);
  if (!matchedId) return;
  const itemId = matchedId[1];

  const ui = document.createElement('div');
  ui.style = `
    position:fixed;right:20px;bottom:20px;width:240px;z-index:9999;
    background:#fff;color:#000;border:1px solid #000;padding:10px;
    border-radius:8px;font-size:14px;box-shadow:2px 2px 8px rgba(0,0,0,0.2);
  `;
  ui.innerHTML = `
    <style>
      .msu-ui-block {
        margin-top: 6px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 13px;
      }
      .msu-ui-block input {
        width: 90px;
        padding: 2px 4px;
        border: 1px solid #000;
        border-radius: 4px;
        font-size: 13px;
      }
      .msu-ui-btn {
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 13px;
        cursor: pointer;
      }
      .start-btn { background: #dff0d8; border: 1px solid #4cae4c; }
      .stop-btn { background: #f2dede; border: 1px solid #d43f3a; }
      .status-green { color: green; font-weight: bold; }
      .status-red { color: red; font-weight: bold; }
    </style>
    <div id="mainUI">
      <div class="msu-ui-block">ğŸ¯ è´­ä¹°ä»·æ ¼ï¼š<input id="targetInput" type="number" value="${targetPrice}" /></div>
      <div class="msu-ui-block">ğŸ’° è´­ä¹°æº¢ä»·ï¼š<input id="premiumInput" type="number" value="${premiumPrice}" /></div>
      <div class="msu-ui-block">ğŸ’° å”®å‡ºä»·æ ¼ï¼š<input id="sellPriceInput" type="number" value="${sellPrice}" /></div>
      <div class="msu-ui-block">ğŸ“ˆ é¢„æœŸåˆ©æ¶¦ï¼š<span id="profitDisplay">--</span></div>
      <div class="msu-ui-block">â±ï¸ ä¸‹æ¬¡å”®å‡ºï¼š<span id="countdownText">--</span></div>
      <div class="msu-ui-block">ğŸ“‰ å½“å‰ä»·æ ¼ï¼š<span id="priceInfo">--</span></div>
      <div class="msu-ui-block">
        âœ… <button id="startBtn" class="msu-ui-btn start-btn">å¯åŠ¨</button>
        â›” <button id="stopBtn" class="msu-ui-btn stop-btn">åœæ­¢</button>
      </div>
      <div class="msu-ui-block">ğŸ“Œ å½“å‰çŠ¶æ€ï¼š<span id="statusDisplay" class="${isRunning ? 'status-green' : 'status-red'}">${isRunning ? 'å¯åŠ¨ä¸­' : 'åœæ­¢'}</span></div>
      <div class="msu-ui-block" id="cooldownDisplay"></div>
    </div>
    <div class="msu-ui-block"><button id="toggleUI" class="msu-ui-btn" style="border:1px solid #000;">ğŸ”½ æ”¶èµ·é¢æ¿</button></div>
  `;

  document.body.appendChild(ui);
  updateProfitDisplay(); // é¡µé¢åŠ è½½åé¦–æ¬¡è®¡ç®—

    // æ¯10åˆ†é’Ÿåˆ·æ–°é¡µé¢ä¸€æ¬¡ï¼ˆä¸å½±å“ countdownï¼‰
setInterval(() => {
  if (isRunning) {
    localStorage.setItem(countdownKey, countdown.toString());
    console.log("ğŸ” 10åˆ†é’Ÿåˆ°ï¼Œä¿å­˜ countdown =", countdown, "å³å°†åˆ·æ–°é¡µé¢");
    location.reload();
  }
}, 600000); // 600000ms = 10åˆ†é’Ÿ


  const countdownText = document.getElementById('countdownText');
  const cooldownDisplay = document.getElementById('cooldownDisplay');
  const priceInfoDisplay = document.getElementById('priceInfo');

  function updateProfitDisplay() {
  if (isNaN(targetPrice) || isNaN(sellPrice)) {
    document.getElementById("profitDisplay").textContent = "--";
    return;
  }
  const afterTax = sellPrice * 0.95;
  const profit = Math.floor(afterTax - targetPrice);
  document.getElementById("profitDisplay").textContent = profit;
}


  function updateCooldownDisplay() {
    cooldownDisplay.textContent = greenErrorCooldown ? `â³ ç»¿è‰²æŠ¥é”™å†·å´ä¸­ï¼š${greenErrorTimer}s` : '';
  }

  document.getElementById('targetInput').onchange = (e) => {
    const val = parseInt(e.target.value);
    if (!isNaN(val)) {
      targetPrice = val;
      localStorage.setItem(storageKeyPrefix + 'price', targetPrice);
    }
    e.target.value = targetPrice;
    updateProfitDisplay();
  };
  document.getElementById('premiumInput').onchange = (e) => {
    const val = parseInt(e.target.value);
    if (!isNaN(val) && val >= 0) {
      premiumPrice = val;
      localStorage.setItem(storageKeyPrefix + 'premium', premiumPrice);
    }
    e.target.value = premiumPrice;
  };
  document.getElementById('sellPriceInput').onchange = (e) => {
    const val = parseInt(e.target.value);
    if (!isNaN(val)) {
      sellPrice = val;
      localStorage.setItem("msu_auto_sell", sellPrice);
    }
    e.target.value = sellPrice;
    updateProfitDisplay();

  };
  document.getElementById('startBtn').onclick = () => {
    isRunning = true;
    localStorage.setItem(storageKeyPrefix + 'running', 'true');
    document.getElementById('statusDisplay').textContent = 'âœ… å½“å‰çŠ¶æ€ï¼šå¯åŠ¨ä¸­';
    if (!mainLoopRunning) mainLoop();
  };
  document.getElementById('stopBtn').onclick = () => {
    isRunning = false;
    localStorage.setItem(storageKeyPrefix + 'running', 'false');
    document.getElementById('statusDisplay').textContent = 'â›” å½“å‰çŠ¶æ€ï¼šåœæ­¢';
  };
  document.getElementById('toggleUI').onclick = () => {
    collapsed = !collapsed;
    document.getElementById('mainUI').style.display = collapsed ? 'none' : 'block';
    document.getElementById('toggleUI').textContent = collapsed ? 'ğŸ”¼ å±•å¼€é¢æ¿' : 'ğŸ”½ æ”¶èµ·é¢æ¿';
  };

  // å€’è®¡æ—¶æ§åˆ¶ + å”®å‡º
  setInterval(() => {
    if (!isRunning || sellPrice <= 0) {
      countdownText.textContent = '--';
      return;
    }
    countdown--;
    const min = Math.floor(countdown / 60);
    const sec = countdown % 60;
    countdownText.textContent = `${min}åˆ†${sec.toString().padStart(2, '0')}ç§’`;
    if (countdown <= 0) {
      console.log("â° å€’è®¡æ—¶ç»“æŸï¼Œæ‰§è¡Œå”®å‡º");
      startSellProcess(sellPrice);
      countdown = 1500;
    }
  }, 1000);

  async function mainLoop() {
    mainLoopRunning = true;
    while (isRunning) {
      try {
        if (isBuying || greenErrorCooldown || countdown <= 30) {
          await new Promise(r => setTimeout(r, 1000));
          continue;
        }

        const res = await fetch(`https://msu.io/marketplace/api/marketplace/explore/consumables/${itemId}/summaries`);
        if (!res.ok || !res.headers.get("content-type")?.includes("json")) {
          await new Promise(r => setTimeout(r, 10000));
          continue;
        }

        const data = await res.json();
        const summaries = data.summaries || [];
        if (summaries.length > 0) {
          const min = summaries.reduce((a, b) => (BigInt(a.priceWei) < BigInt(b.priceWei) ? a : b));
          const realPrice = Math.round(Number(min.priceWei) / 1e18);
          priceInfoDisplay.textContent = `å½“å‰ä»·ï¼š${realPrice}`;
          if (realPrice <= targetPrice) {
            isBuying = true;
            autoBuy(min.priceWei, min.quantity, realPrice);
          }
        }
      } catch (e) {
        isBuying = false;
      }
      await new Promise(r => setTimeout(r, 7000 + Math.random() * 1000));
    }
    mainLoopRunning = false;
  }

function autoBuy(priceWei, quantity, expectedPrice) {
  try {
    const input = document.querySelector('#consumable-buy-form input');
    if (!input) { isBuying = false; return; }

    const nativeInputValueSetter = Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype, 'value').set;
    nativeInputValueSetter.call(input, quantity);
    input.dispatchEvent(new Event('input', { bubbles: true }));

    const buyBtn = document.querySelector('#consumable-buy-form button');
    if (!buyBtn) { isBuying = false; return; }

    const redX = document.querySelector('#insufficient-balance-modal > div > button');
    if (redX && redX.offsetParent !== null && !redX.disabled) {
      redX.click();
      isBuying = false;
      return;
    }

    const greenX = document.querySelector('[id^="b_"] > div > button');
    if (greenX && greenX.offsetParent !== null && !greenX.disabled) {
      greenX.click();
      isBuying = false;
      triggerGreenErrorCooldown();
      return;
    }

      setTimeout(() => {
          buyBtn.click();  // ç‚¹å‡» Buy

          let confirmWait = 0;
          const waitConfirm = setInterval(() => {
              let confirmBtn = document.querySelector(
                  '#purchase-consumables-modal > div > div > div._13upqul3._13upqul1.pbjki00 > button'
              );
              if (!confirmBtn) {
                  confirmBtn = [...document.querySelectorAll("#purchase-consumables-modal button")]
                      .find(btn => btn.innerText.includes("Confirm"));
              }

              if (confirmBtn && confirmBtn.offsetParent !== null) {
                  clearInterval(waitConfirm);
                  console.log("ğŸŸ¢ æ£€æµ‹åˆ°ç¡®è®¤å¼¹çª—ï¼Œç­‰å¾…1ç§’åè¯»å–ä»·æ ¼...");

                  // â–¼â–¼â–¼ æ”¹åŠ¨ç‚¹ 1ï¼šæŒ‰æ‚¨çš„è¦æ±‚ï¼Œæ›¿æ¢ä¸ºå›ºå®šçš„1ç§’å»¶æ—¶ â–¼â–¼â–¼
                  setTimeout(() => {
                      console.log("...1ç§’å»¶æ—¶ç»“æŸï¼Œå¼€å§‹äºŒæ¬¡ä»·æ ¼éªŒè¯...");

                      let actualModalPrice = null;
                      const priceSelectors = [
                          '#purchase-consumables-modal span[class*="bngdhoj"] > span',
                          '#purchase-consumables-modal span[class*="DecimalPrice_decimalValue"]'
                      ];

                      // éå†æ‰€æœ‰å¯èƒ½çš„é€‰æ‹©å™¨æ¥æ‰¾ä»·æ ¼
                      for (const selector of priceSelectors) {
                          const priceElement = document.querySelector(selector);
                          if (priceElement) {
                              const priceText = priceElement.innerText.replace(/,/g, '');
                              if (priceText) {
                                  const parsedPrice = parseInt(priceText, 10);
                                  if (!isNaN(parsedPrice)) {
                                      actualModalPrice = parsedPrice;
                                      break; // æ‰¾åˆ°å°±è·³å‡ºå¾ªç¯
                                  }
                              }
                          }
                      }

                      // --- æœ€ç»ˆå†³ç­–é€»è¾‘ ---
                      if (actualModalPrice !== null && actualModalPrice <= (targetPrice + premiumPrice)) {
                          console.log(`âœ… ä»·æ ¼åœ¨å®¹è®¸èŒƒå›´å†… (ç›®æ ‡ä»·+æº¢ä»·: ${targetPrice + premiumPrice}, å®é™…: ${actualModalPrice}). ç»§ç»­è´­ä¹°ã€‚`);
                          realMouseClick(confirmBtn);

                          // æ‚¨çš„â€œ3ç§’å¡æ­»æ£€æŸ¥â€é€»è¾‘ï¼Œä¿æŒä¸å˜
                          setTimeout(() => {
                              const confirmStill = [...document.querySelectorAll("#purchase-consumables-modal button")]
                              .find(btn => btn.innerText.includes("Confirm"));

                              if (!confirmStill || confirmStill.offsetParent === null) {
                                  console.log("âœ… ç¡®è®¤æŒ‰é’®å·²æ¶ˆå¤±ï¼Œç­‰å¾…é’±åŒ…ç­¾åä¸­...");
                                  setTimeout(() => {
                                      const closeBtn = document.querySelector('#make-transaction-sign > div > button');
                                      if (closeBtn && closeBtn.offsetParent !== null && !closeBtn.disabled) {
                                          closeBtn.click();
                                          console.log("âœ… å·²ç‚¹å‡»ç­¾åå¼¹çª—å…³é—­æŒ‰é’®");
                                      }
                                      addRecord(Math.round(Number(priceWei) / 1e18), quantity);
                                      isBuying = false;
                                  }, 30000);
                              } else {
                                  console.warn("ğŸŸ¥ 3 ç§’åç¡®è®¤æŒ‰é’®ä»åœ¨ï¼Œå°è¯•å…³é—­å¼¹çª—");
                                  const closeBtn = document.evaluate(
                                      '//*[@id="purchase-consumables-modal"]/div/button', document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null
                                  ).singleNodeValue;
                                  if (closeBtn && closeBtn.offsetParent !== null && !closeBtn.disabled) {
                                      realMouseClick(closeBtn);
                                      console.log("âœ… å·²å¼ºåˆ¶å…³é—­å¡æ­»å¼¹çª—");
                                  } else {
                                      console.log("âš ï¸ æ‰¾ä¸åˆ°å…³é—­æŒ‰é’®");
                                  }
                                  isBuying = false;
                              }
                          }, 8000);
                      } else {
                          // â–¼â–¼â–¼ æ”¹åŠ¨ç‚¹ 2ï¼šæŒ‰æ‚¨çš„è¦æ±‚ï¼Œä»·æ ¼ä¸ç¬¦æ—¶ï¼Œç­‰å¾…4ç§’å†å…³é—­ â–¼â–¼â–¼
                          if (actualModalPrice === null) {
                              console.warn(`âŒ æœªèƒ½è¯»å–åˆ°å¼¹çª—ä»·æ ¼ï¼Œä¸ºå®‰å…¨èµ·è§ï¼Œ4ç§’åå…³é—­å¼¹çª—ã€‚`);
                          } else {
                              console.warn(`ğŸŸ¥ ä»·æ ¼è¶…å‡ºæº¢ä»·èŒƒå›´ï¼Œ4ç§’åå…³é—­å¼¹çª—ï¼(ä¸Šé™: ${targetPrice + premiumPrice}, å®é™…: ${actualModalPrice})`);
                          }

                          setTimeout(() => {
                              console.log("...4ç§’å»¶æ—¶ç»“æŸï¼Œæ‰§è¡Œå…³é—­æ“ä½œã€‚");
                              const closeBtn = document.evaluate(
                                  '//*[@id="purchase-consumables-modal"]/div/button', document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null
                              ).singleNodeValue;
                              if (closeBtn && closeBtn.offsetParent !== null && !closeBtn.disabled) {
                                  realMouseClick(closeBtn);
                                  console.log("ğŸ”´ å·²ç‚¹å‡»å…³é—­æŒ‰é’®ï¼Œå–æ¶ˆäº¤æ˜“ã€‚");
                              } else {
                                  console.error("âŒ æœªèƒ½æ‰¾åˆ°å¼¹çª—çš„å…³é—­æŒ‰é’®ï¼");
                              }
                              isBuying = false;
                          }, 8000); // 4ç§’å»¶æ—¶
                      }
                  }, 1000); // 1ç§’å»¶æ—¶
              } else {
                  confirmWait += 500;
                  if (confirmWait >= 15000) {
                      clearInterval(waitConfirm);
                      console.warn("âš ï¸ è¶…æ—¶æœªå‡ºç°ç¡®è®¤æŒ‰é’®ï¼Œå¼ºåˆ¶é€€å‡ºè´­ä¹°æµç¨‹");
                      const closeBtn = document.evaluate(
                          '//*[@id="purchase-consumables-modal"]/div/button', document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null
                      ).singleNodeValue;
                      if (closeBtn && closeBtn.offsetParent !== null && !closeBtn.disabled) {
                          realMouseClick(closeBtn);
                          console.log("ğŸ”´ è¶…æ—¶åï¼Œå¼ºåˆ¶å…³é—­å¯èƒ½å­˜åœ¨çš„å¼¹çª—ã€‚");
                      }
                      isBuying = false;
                  }
              }
          }, 500);
      }, 500);
  } catch (e) {
      isBuying = false;
      console.warn("âš ï¸ autoBuy å‡ºé”™ï¼š", e);
  }
}


  // âœ… åŸç‰ˆ v0.6 äººå·¥è¾“å…¥é€»è¾‘
  function humanInput(el, value) {
    el.focus();
    el.select();
    document.execCommand("insertText", false, value.toString());
    el.dispatchEvent(new Event("input", { bubbles: true }));
    console.log(`âœï¸ æ¨¡æ‹Ÿè¾“å…¥: ${value}`);
  }

  // âœ… åŸç‰ˆ v0.6 å”®å‡ºé€»è¾‘
  function startSellProcess(sellPrice) {
    console.log("ğŸŸ¡ å”®å–æµç¨‹å¼€å§‹");

    const sellTab = document.querySelector(
      'body > div._1lniw0n2 > div > div > div._1a272vx2.z0h83i4._6swxj41eo.oeasfv1qc.oeasfvwo.oeasfvii.oeasfv1a6.oeasfv2e > section._18sp21p4._1kz7vuf6._1kz7vuf2u._1kz7vuf20._1kz7vuf1q._6swxj42bo._6swxj41gu.pbjki00.pbjki0nc._18sp21p0.zv8p3u0._6jsraw0._18sp21pc._3w91wn1.form > div.bid-header.pbjki00.pbjki020.pbjki0n6.pbjki05o.oeasfv1po.oeasfv1p2.oeasfvw0.oeasfvve.oeasfvg6.oeasfvfq.oeasfv1aw._48etwsm0._48etwslk > ul > li:nth-child(2)'
    );

    if (!sellTab) return console.warn("âŒ æœªæ‰¾åˆ° Tab");
    sellTab.dispatchEvent(new MouseEvent("click", { bubbles: true }));
    console.log("âœ… å·²ç‚¹å‡» Sell Tab");

    const formWait = setInterval(() => {
      const qtySpan = document.querySelector('#consumable-sell-form > fieldset > p > span');
      const qtyInput = document.querySelector('#consumable-sell-form input[name="quantity"]');
      const priceInput = document.querySelector('#consumable-sell-form > fieldset > label input');
      const sellBtn = document.querySelector('#consumable-sell-form > fieldset > button');

      if (qtySpan && qtyInput && priceInput && sellBtn) {
        clearInterval(formWait);
        console.log("âœ… è¡¨å•å·²åŠ è½½");

        const match = qtySpan.textContent.replace(/,/g, '').match(/\d+/);
        if (!match) return console.warn("âŒ æ•°é‡æœªè·å–");
        const sellQty = match[0];

        humanInput(priceInput, sellPrice);
        setTimeout(() => {
          humanInput(qtyInput, sellQty);

          setTimeout(() => {
            sellBtn.dispatchEvent(new MouseEvent("click", { bubbles: true }));
            console.log("ğŸ“¤ å·²ç‚¹å‡» Sell æäº¤");

            const waitConfirm = setInterval(() => {
              const confirmBtn = document.querySelector('#sale-consumables-modal > div > div > div._13upqul3._13upqul1.pbjki00 > button');
              if (confirmBtn && confirmBtn.offsetParent !== null && !confirmBtn.disabled) {
                confirmBtn.click();
                clearInterval(waitConfirm);
                console.log("âœ… å·²ç‚¹å‡»ç¡®è®¤æŒ‰é’®");
                setTimeout(() => {
                  console.log("ğŸ”„ ç­‰å¾…20ç§’ååˆ·æ–°é¡µé¢");
                  location.reload();
                }, 20000);
              }
            }, 500);
          }, 600);
        }, 600);
      }
    }, 500);
  }

  function realMouseClick(el) {
    const evt = new MouseEvent('click', { bubbles: true, cancelable: true, view: window });
    el.dispatchEvent(evt);
  }

  function triggerGreenErrorCooldown() {
    greenErrorCooldown = true;
    greenErrorTimer = 180;
    const timer = setInterval(() => {
      greenErrorTimer--;
      updateCooldownDisplay();
      if (greenErrorTimer <= 0) {
        greenErrorCooldown = false;
        clearInterval(timer);
        updateCooldownDisplay();
      }
    }, 1000);
    updateCooldownDisplay();
    fetch("http://127.0.0.1:30304/start-change-ip").catch(() => {});
  }

  function addRecord(price, quantity) {
    const now = new Date().toLocaleString();
    const total = price * quantity;
    const body = JSON.stringify({ time: now, price, quantity, total });
    fetch("http://127.0.0.1:30303/record", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body
    }).catch(() => {});
  }
if (isRunning && !mainLoopRunning) mainLoop();


})();


language race where violin this genuine skill size maze lonely female bulb
